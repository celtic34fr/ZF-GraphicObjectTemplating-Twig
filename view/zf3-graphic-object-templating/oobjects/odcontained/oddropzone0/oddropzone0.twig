{# mod_le pour l'affichage de l'objet ODDropzone #}

{% set files = {} %}
{% if objet.files is not empty %}
    {% set files = objet.files %}
{% endif %}

<div role="content" data-gui-object="1" id="{{ objet.id }}" >
    <!-- widget edit box -->
    <div class="jarviswidget-editbox">
        <!-- This area used as dropdown edit box -->
    </div>
    <!-- end widget edit box -->
    <!-- -->
    <!-- widget content -->
    <div class="widget-body">
        <form action="{{ basePath('objets/affiche/html') }}" class="dropzone dz-clickable" id="aaa{{ objet.id }}">
            <input type="hidden"  name="lenght" value="ok">
            <input type="hidden" id="data{{ objet.id }}" name="data" value="">
            <input type="hidden" name="event" value="{{ '\Objets\Event::EVT_DROP_IN' }}">
            <input type="hidden"  name="objetSource" value="{{ objet.id }}">
            <div class="dz-default dz-message"><span>Déposer vos fichiers ...</span></div>
        </form>
    </div>
    <!-- end widget content -->

    <script>
        $(document).ready(function() {
            Dropzone.autoDiscover = false;
            var {{ objet.id }}Dropzone = new Dropzone("aaa{{ objet.id }}", {
                url             : "{{ basePath(objets/affiche/html) }}",
            {% if objet.acceptedFiles is not empty %}
                acceptedFiles   : "{{ objet.acceptedFiles }}",
            {% endif %}
                dictRemoveFile  : "Sup. fichier",
                dictFileTooBig  : "Fichier trop volumineux ({{filesize}}MB)  Max : {{maxFilesize}}MB.",
                dictInvalidFileType: "You can't upload files of this type.",
                dictResponseError: "Server responded with {{statusCode}} code.",
                dictCancelUpload: "Annuler téléchargement",
                maxFilesize: {{ object.maxFileSize }},
                dictResponseError: 'Erreur téléchargement !',
                paramName : "file",
                complete: function(file) {
                    console.log("la ici");
                    html = file.xhr.response;
                    objetAjaxParser(html);
                },
                init: function() {
                    var myDropzone = this;
                    {% set loadedFiles = objet.loadedFiles %}
                    {% if (loadedFile is not empty) and (loadedFile|length > 0)  %}
                    var json = '{{ loadedFiles|json_encode }}';
                    var loadedFiles = JSON.parse(json);

                    console.log('loadedFiles');
                    console.log(loadedFiles);
                    console.log('loadedFiles');

                    for (var i = 0; i < loadedFiles.length; i++) {
                        var mockFile = {
                            name: loadedFiles[i].name,
                            size: loadedFiles[i].size,
                        };

                        var viewButton   = Dropzone.createElement("<a href='/blob/view/"+loadedFiles[i].idBlob+"' target='_blank' class='btn btn-info btn-xs' style='margin-left: 2px;margin-right: 2px'><i class='fa fa-eye'></i></a>");
                        var downloadButton   = Dropzone.createElement("<a href='/blob/download/"+loadedFiles[i].idBlob+"' class='btn btn-primary btn-xs' style='margin-left: 2px;margin-right: 2px;'><i class='fa fa-download'></i></a>");
                        var removeButton = Dropzone.createElement("<button class='btn btn-warning btn-xs' style='margin-left: 2px;margin-right: 2px' ><i class='fa fa-trash-o'></i></button>");
                        var url  =  "/blob/view/"+loadedFiles[i].idBlob;
                        var urld  =  "/blob/download/"+loadedFiles[i].idBlob;

                        console.log(url);

                        removeButton.addEventListener("click", function(e) {
                            e.preventDefault();
                            e.stopPropagation();

                            var idObject = $(this).parent().attr('id');
                            console.log('removeButton clickEvent');
                            console.log(idObject);

                            $('#{{ objet.id }}').data("selected", idObject);

                            {{ '\Objets\Event::EVT_DROP_OUT' }}
                        });

                        myDropzone.emit("addedfile", mockFile);
                        myDropzone.emit("thumbnail", mockFile, loadedFiles[i].url);
                        myDropzone.emit("success", mockFile);

                        var element = $(mockFile.previewElement).find('.dz-details');
                        element.parent().attr('id', loadedFiles[i].name);
                        {% if objet.view %}
                        element.parent().append(viewButton);
                        {% endif %}
                        {% if objet.download %}
                        element.parent().append(downloadButton);
                        {% endif %}
                        {% if objet.remove %}
                        element.parent().append(removeButton);
                        {% endif %}
                    },

                    accept: function(file, done) {

                        var fileName = file.name;
                        var arrayFile = {'name': file.name, 'type': file.type, 'size': file.size};
                        var arrayFiles = {fileName: arrayFile};
                        <!--console.log("zzzzzzzzzzzzzzz");-->
                        <!--console.log(arrayFiles);-->
                        $('#{{ objet.id }}').data("files", arrayFiles);

                        $("#data{{ objet.id }}").val(JSON.stringify($("#{{ objet.id }}").data()));

                        if (file.name == "justinbieber.jpg") {
                            done("Naha, you don't.");
                        } else {
                            done("");
                        }
                    }
                    {% endif %}
                },
            });
            {% if objet.actif == false %}
            {{ objet.id }}Dropzone.disable();
            {% else %}
            {{ objet.id }}Dropzone.enable();
            {% endif %}
        });
    </script>
</div>
